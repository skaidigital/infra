name: GitHub Push Notifications to Slack

on:
  schedule:
    # Run every hour to check for new pushes
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering

# Automatically monitors all active (non-archived) repositories in the organization

jobs:
  notify-pushes:
    name: Check for new pushes and notify Slack
    runs-on: blacksmith-8vcpu-ubuntu-2204
    timeout-minutes: 10

    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for accurate analysis

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "::error::ANTHROPIC_API_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "::error::SLACK_WEBHOOK_URL secret is not set"
            exit 1
          fi

      - name: Process repository pushes and generate summaries
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          github-token: ${{ secrets.PRIVATE_REPOS_PAT }}
          script: |
            const script = await import('file://' + process.cwd() + '/.github/scripts/process-pushes.js')
            await script.default({github, context, core})